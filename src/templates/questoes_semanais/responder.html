{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>{{ questoes_semanais.titulo }}</h1>
            <p class="text-muted">
                Semana de {{ questoes_semanais.semana_referencia.strftime('%d/%m/%Y') }}
            </p>
        </div>
        <div>
            <button id="finalizar-btn" class="btn btn-primary" style="display: none;">
                Finalizar e Enviar Respostas
            </button>
            <div id="timer" class="badge bg-info fs-5">00:00:00</div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Instruções</h5>
            <ul class="mb-0">
                <li>Você tem tempo ilimitado para responder as questões</li>
                <li>Marque apenas uma alternativa por questão</li>
                <li>Você pode revisar suas respostas antes de finalizar</li>
                <li>Após finalizar, você poderá ver o gabarito</li>
            </ul>
        </div>
    </div>
    
    <form id="form-respostas">
        <div class="questoes">
            {% for questao in questoes_semanais.questoes %}
            <div class="card mb-4 questao" id="questao-{{ questao.numero }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Questão {{ questao.numero }}</h5>
                    <span class="badge bg-info">{{ questao.materia }}</span>
                </div>
                <div class="card-body">
                    <div class="questao-enunciado mb-4">
                        {{ questao.enunciado|safe }}
                    </div>
                    
                    <div class="alternativas">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="q{{ questao.id }}" 
                                   id="q{{ questao.id }}_a" value="A" required>
                            <label class="form-check-label" for="q{{ questao.id }}_a">
                                A) {{ questao.alternativa_a }}
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="q{{ questao.id }}" 
                                   id="q{{ questao.id }}_b" value="B">
                            <label class="form-check-label" for="q{{ questao.id }}_b">
                                B) {{ questao.alternativa_b }}
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="q{{ questao.id }}" 
                                   id="q{{ questao.id }}_c" value="C">
                            <label class="form-check-label" for="q{{ questao.id }}_c">
                                C) {{ questao.alternativa_c }}
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="q{{ questao.id }}" 
                                   id="q{{ questao.id }}_d" value="D">
                            <label class="form-check-label" for="q{{ questao.id }}_d">
                                D) {{ questao.alternativa_d }}
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="q{{ questao.id }}" 
                                   id="q{{ questao.id }}_e" value="E">
                            <label class="form-check-label" for="q{{ questao.id }}_e">
                                E) {{ questao.alternativa_e }}
                            </label>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-outline-primary marcar-respondida" 
                                data-questao="{{ questao.id }}">
                            Marcar como Respondida
                        </button>
                        <div class="resposta-status mt-2 d-none" id="status-{{ questao.id }}">
                            <div class="alert alert-success">
                                Questão respondida!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="sticky-bottom bg-light p-3 border-top">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="questoes-respondidas">0</span> de {{ questoes_semanais.total_questoes }} questões respondidas
                </div>
                <button type="submit" class="btn btn-primary" id="enviar-respostas">
                    Finalizar e Enviar Respostas
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmacaoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Envio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja finalizar e enviar suas respostas?</p>
                <p>Você respondeu <span id="modal-questoes-respondidas">0</span> de {{ questoes_semanais.total_questoes }} questões.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmar-envio">Confirmar</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let startTime = new Date();
    let timerInterval;
    let questoesRespondidas = 0;
    const totalQuestoes = {{ questoes_semanais.total_questoes }};
    
    // Iniciar timer
    function updateTimer() {
        const now = new Date();
        const diff = now - startTime;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        document.getElementById('timer').textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    timerInterval = setInterval(updateTimer, 1000);
    
    // Marcar questão como respondida
    document.querySelectorAll('.marcar-respondida').forEach(button => {
        button.addEventListener('click', function() {
            const questaoId = this.dataset.questao;
            const statusDiv = document.getElementById(`status-${questaoId}`);
            const radioInputs = document.querySelectorAll(`input[name="q${questaoId}"]`);
            
            if (Array.from(radioInputs).some(input => input.checked)) {
                statusDiv.classList.remove('d-none');
                questoesRespondidas++;
                updateQuestoesRespondidas();
                this.disabled = true;
            } else {
                alert('Por favor, selecione uma alternativa antes de marcar como respondida.');
            }
        });
    });
    
    // Atualizar contador de questões respondidas
    function updateQuestoesRespondidas() {
        document.getElementById('questoes-respondidas').textContent = questoesRespondidas;
        document.getElementById('modal-questoes-respondidas').textContent = questoesRespondidas;
        
        if (questoesRespondidas === totalQuestoes) {
            document.getElementById('finalizar-btn').style.display = 'block';
        }
    }
    
    // Enviar respostas
    document.getElementById('form-respostas').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const modal = new bootstrap.Modal(document.getElementById('confirmacaoModal'));
        modal.show();
    });
    
    document.getElementById('confirmar-envio').addEventListener('click', function() {
        const form = document.getElementById('form-respostas');
        const formData = new FormData(form);
        const respostas = [];
        
        // Coletar respostas
        for (let [name, value] of formData.entries()) {
            if (name.startsWith('q')) {
                const questaoId = name.substring(1);
                respostas.push({
                    questao_id: parseInt(questaoId, 10),
                    resposta: value,
                    tempo_gasto: Math.floor((new Date() - startTime) / 1000)
                });
            }
        }
        
        // Enviar para o servidor
        fetch("{{ url_for('questoes_semanais.salvar_respostas', id=questoes_semanais.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: {% if current_user.is_authenticated %}{{ current_user.id }}{% else %}null{% endif %},
                respostas: respostas
            })
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(timerInterval);
            window.location.href = "{{ url_for('questoes_semanais.visualizar_questoes_semanais', id=questoes_semanais.id) }}";
        })
        .catch(error => {
            console.error('Erro ao enviar respostas:', error);
            alert('Erro ao enviar respostas. Por favor, tente novamente.');
        });
    });
});
</script>
{% endblock %}
{% endblock %} 