<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.title }} - Concentrify</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/products.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-menu">
                <a href="{{ url_for('products.index') }}">Produtos</a>
                {% if session.get('is_admin') %}
                <a href="{{ url_for('admin.list_users') }}">Gerenciar Usuários</a>
                {% endif %}
                <a href="{{ url_for('auth.logout') }}">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="flash-messages">
            {% for category, message in get_flashed_messages(with_categories=true) %}
                <div class="flash-message flash-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>

        <div class="pdf-container">
            <div class="pdf-header">
                <a href="{{ url_for('products.index') }}" class="pdf-back">← Voltar</a>
                <h1 class="pdf-title">{{ product.title }}</h1>
            </div>
            
            <div class="pdf-content">
                <div id="pdf-viewer"></div>
            </div>
        </div>
    </div>

    <style>
        .pdf-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .pdf-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .pdf-title {
            font-size: 24px;
            font-weight: 500;
            margin: 0;
            color: #333;
        }
        
        .pdf-back {
            margin-right: 15px;
            color: #3f51b5;
            text-decoration: none;
            font-weight: 500;
        }
        
        .pdf-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #pdf-viewer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .pdf-page {
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 100%;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .pdf-container {
                padding: 15px;
                margin: 0 10px;
            }
            
            .pdf-title {
                font-size: 20px;
            }
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 16px;
        }
        
        .error-message {
            text-align: center;
            color: #dc3545;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .error-details {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
    </style>

    <script>
        // Configuração do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        
        // Caminho para o PDF
        const pdfUrl = "{{ url_for('products.get_pdf', filename=product.pdf_file) }}";
        const pdfViewer = document.getElementById('pdf-viewer');
        
        // Função para renderizar o PDF como imagens
        async function renderPDF() {
            try {
                // Mostra mensagem de carregamento
                pdfViewer.innerHTML = '<p class="loading">Carregando PDF...</p>';
                
                // Carrega o documento PDF
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                const pdf = await loadingTask.promise;
                
                // Limpa o visualizador
                pdfViewer.innerHTML = '';
                
                // Renderiza cada página como uma imagem
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    
                    // Escala da página (ajuste conforme necessário)
                    const viewport = page.getViewport({ scale: 1.5 });
                    
                    // Cria um canvas para a página
                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-page';
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    // Renderiza a página no canvas
                    const context = canvas.getContext('2d');
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    
                    await page.render(renderContext).promise;
                    
                    // Adiciona o canvas ao visualizador
                    pdfViewer.appendChild(canvas);
                }
            } catch (error) {
                console.error('Erro ao renderizar o PDF:', error);
                pdfViewer.innerHTML = `
                    <div class="error-message">
                        <p>Não foi possível carregar o PDF. Por favor, tente novamente mais tarde.</p>
                        <p class="error-details">Detalhes: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Inicia a renderização quando a página carregar
        document.addEventListener('DOMContentLoaded', renderPDF);
    </script>
</body>
</html>
